AnalysisType: rule
Filename: aws_guardduty_bitcoin_mining_demo.py
RuleID: "AWS.GuardDuty.BitcoinMining.Demo"
DisplayName: "AWS GuardDuty Bitcoin Mining Activity Detected"
Enabled: true
LogTypes:
  - AWS.GuardDuty
Severity: High
DedupPeriodMinutes: 60
Description: >
  Detects when AWS GuardDuty reports an EC2 instance is likely being used for unauthorized bitcoin or cryptocurrency mining, based on findings 'CryptoCurrency:EC2/BitcoinTool.B' or 'CryptoCurrency:EC2/BitcoinTool.B!DNS'.
Tags:
  # Required tags
  - compliance.soc2
  - usecase.siem_integrity
  # Optional tags
  - mitre.ta0040.impact
  - mitre.t1496.resource_hijacking
  - asset.detection_controls
  - threat.external
  - impact.availability

Reports:
  MITRE ATT&CK:
    - TA0040:T1496 # Impact: Resource Hijacking
Reference: https://docs.aws.amazon.com/guardduty/latest/ug/guardduty_finding-types-ec2.html
Runbook: |
  1. Query VPC Flow Logs and CloudTrail for all network connections and API calls from the affected EC2 instance in the 24 hours before the finding
  2. Find all IAM activity and other GuardDuty findings for the instance's IAM role in the past 7 days to identify potential compromise or lateral movement
  3. Check if the instance was recently launched or if user data scripts were modified within 48 hours before the finding
SummaryAttributes:
  - severity
  - type
  - title
  - resource:instanceDetails:instanceId
  - accountId
  - region
Threshold: 1
Tests:
  - Name: Detects Bitcoin Mining (Positive)
    ExpectedResult: true
    Log:
      schemaVersion: "2.0"
      accountId: "123456789012"
      region: "us-east-1"
      partition: "aws"
      arn: "arn:aws:guardduty:us-east-1:123456789012:detector/111111bbbbbbbbbb5555555551111111/finding/abcdef123456"
      id: "abcdef123456"
      type: "CryptoCurrency:EC2/BitcoinTool.B"
      resource:
        instanceDetails:
          instanceId: "i-0abc123def456"
      severity: 8.0
      createdAt: "2025-07-11T20:59:01.571Z"
      updatedAt: "2025-07-11T20:59:01.571Z"
      title: "Bitcoin mining activity detected"
      description: "An EC2 instance is querying an IP address associated with bitcoin mining."
      service:
        serviceName: "guardduty"
        detectorId: "111111bbbbbbbbbb5555555551111111"
        resourceRole: "TARGET"
        archived: false
        count: 1
  - Name: Not Bitcoin Mining (Negative)
    ExpectedResult: false
    Log:
      schemaVersion: "2.0"
      accountId: "123456789012"
      region: "us-east-1"
      partition: "aws"
      arn: "arn:aws:guardduty:us-east-1:123456789012:detector/111111bbbbbbbbbb5555555551111111/finding/abcdef654321"
      id: "abcdef654321"
      type: "Recon:EC2/PortProbeUnprotectedPort"
      resource:
        instanceDetails:
          instanceId: "i-0abc123def456"
      severity: 8.0
      createdAt: "2025-07-11T20:59:01.571Z"
      updatedAt: "2025-07-11T20:59:01.571Z"
      title: "Port probe detected"
      description: "An EC2 instance is being probed on an unprotected port."
      service:
        serviceName: "guardduty"
        detectorId: "111111bbbbbbbbbb5555555551111111"
        resourceRole: "TARGET"
        archived: false
        count: 1
  - Name: Low Severity Bitcoin Mining (Negative)
    ExpectedResult: false
    Log:
      schemaVersion: "2.0"
      accountId: "123456789012"
      region: "us-east-1"
      partition: "aws"
      arn: "arn:aws:guardduty:us-east-1:123456789012:detector/111111bbbbbbbbbb5555555551111111/finding/abcdef789012"
      id: "abcdef789012"
      type: "CryptoCurrency:EC2/BitcoinTool.B!DNS"
      resource:
        instanceDetails:
          instanceId: "i-0abc123def456"
      severity: 3.0
      createdAt: "2025-07-11T20:59:01.571Z"
      updatedAt: "2025-07-11T20:59:01.571Z"
      title: "Bitcoin mining activity detected"
      description: "An EC2 instance is querying a domain associated with bitcoin mining."
      service:
        serviceName: "guardduty"
        detectorId: "111111bbbbbbbbbb5555555551111111"
        resourceRole: "TARGET"
        archived: false
        count: 1 