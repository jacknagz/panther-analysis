AnalysisType: rule
Filename: aws_console_login_demo.py
RuleID: "AWS.Console.Login.Demo"
DisplayName: "AWS Console Login"
Enabled: true
LogTypes:
    - AWS.CloudTrail
Severity: Info
DedupPeriodMinutes: 60
Threshold: 1
CreateAlert: false
Description: >
  Detects AWS Management Console login events. This rule tracks all successful 
  and failed console login attempts for monitoring user authentication activity 
  and maintaining audit trails of console access.
Tags:
  - AWS
  - Authentication
  - Console Access
  - Demo
Reports:
  MITRE ATT&CK:
    - "TA0001:T1078"  # Valid Accounts
Tests:
  - Name: "Successful Console Login"
    ExpectedResult: true
    Log:
      awsRegion: "us-east-1"
      eventCategory: "Management"
      eventID: "12345678-1234-1234-1234-123456789012"
      eventName: "ConsoleLogin"
      eventSource: "signin.amazonaws.com"
      eventTime: "2025-08-13 14:30:00"
      eventType: "AwsConsoleSignIn"
      eventVersion: "1.08"
      recipientAccountId: "123456789012"
      requestID: "87654321-4321-4321-4321-210987654321"
      requestParameters: null
      responseElements:
        ConsoleLogin: "Success"
      serviceEventDetails:
        consoleLogin:
          additionalEventData:
            LoginTo: "https://console.aws.amazon.com/console/home"
            MobileVersion: "No"
            MfaType: "SMS MFA"
          responseElements:
            ConsoleLogin: "Success"
      sourceIPAddress: "203.0.113.42"
      userAgent: "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36"
      userIdentity:
        type: "IAMUser"
        principalId: "AIDACKCEVSQ6C2EXAMPLE"
        arn: "arn:aws:iam::123456789012:user/john.doe"
        accountId: "123456789012"
        userName: "john.doe"

  - Name: "Failed Console Login"
    ExpectedResult: true
    Log:
      awsRegion: "us-east-1"
      eventCategory: "Management"
      eventID: "87654321-4321-4321-4321-210987654321"
      eventName: "ConsoleLogin"
      eventSource: "signin.amazonaws.com"
      eventTime: "2025-08-13 14:35:00"
      eventType: "AwsConsoleSignIn"
      eventVersion: "1.08"
      errorCode: "SigninFailure"
      errorMessage: "Failed authentication"
      recipientAccountId: "123456789012"
      requestID: "11223344-5566-7788-9900-aabbccddeeff"
      requestParameters: null
      responseElements:
        ConsoleLogin: "Failure"
      serviceEventDetails:
        consoleLogin:
          additionalEventData:
            LoginTo: "https://console.aws.amazon.com/console/home"
            MobileVersion: "No"
          responseElements:
            ConsoleLogin: "Failure"
      sourceIPAddress: "198.51.100.123"
      userAgent: "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36"
      userIdentity:
        type: "IAMUser"
        principalId: "AIDACKCEVSQ6C2EXAMPLE"
        arn: "arn:aws:iam::123456789012:user/jane.smith"
        accountId: "123456789012"
        userName: "jane.smith"

  - Name: "Root User Console Login"
    ExpectedResult: true
    Log:
      awsRegion: "us-east-1"
      eventCategory: "Management"
      eventID: "aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeeee"
      eventName: "ConsoleLogin"
      eventSource: "signin.amazonaws.com"
      eventTime: "2025-08-13 14:25:00"
      eventType: "AwsConsoleSignIn"
      eventVersion: "1.08"
      recipientAccountId: "123456789012"
      requestID: "ffffffff-gggg-hhhh-iiii-jjjjjjjjjjjj"
      requestParameters: null
      responseElements:
        ConsoleLogin: "Success"
      serviceEventDetails:
        consoleLogin:
          additionalEventData:
            LoginTo: "https://console.aws.amazon.com/console/home"
            MobileVersion: "No"
            MfaType: "Hardware MFA"
          responseElements:
            ConsoleLogin: "Success"
      sourceIPAddress: "192.0.2.100"
      userAgent: "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36"
      userIdentity:
        type: "Root"
        principalId: "123456789012"
        arn: "arn:aws:iam::123456789012:root"
        accountId: "123456789012"

  - Name: "SSO Console Login"
    ExpectedResult: true
    Log:
      awsRegion: "us-west-2"
      eventCategory: "Management"
      eventID: "sso12345-6789-abcd-efgh-ijklmnopqrst"
      eventName: "ConsoleLogin"
      eventSource: "signin.amazonaws.com"
      eventTime: "2025-08-13 14:40:00"
      eventType: "AwsConsoleSignIn"
      eventVersion: "1.08"
      recipientAccountId: "123456789012"
      requestID: "sso98765-4321-dcba-hgfe-tsrqponmlkji"
      requestParameters: null
      responseElements:
        ConsoleLogin: "Success"
      serviceEventDetails:
        consoleLogin:
          additionalEventData:
            LoginTo: "https://console.aws.amazon.com/console/home"
            MobileVersion: "No"
            MfaType: "No MFA"
          responseElements:
            ConsoleLogin: "Success"
      sourceIPAddress: "10.0.1.50"
      userAgent: "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/14.1.1 Safari/605.1.15"
      userIdentity:
        type: "AssumedRole"
        principalId: "AROA1234567890EXAMPLE:admin@company.com"
        arn: "arn:aws:sts::123456789012:assumed-role/AWSReservedSSO_AdminRole_12345/admin@company.com"
        accountId: "123456789012"

  - Name: "Non-Console Login Event (Should Not Trigger)"
    ExpectedResult: false
    Log:
      awsRegion: "us-east-1"
      eventCategory: "Management"
      eventID: "non12345-6789-abcd-efgh-ijklmnopqrst"
      eventName: "CreateAccessKey"
      eventSource: "iam.amazonaws.com"
      eventTime: "2025-08-13 14:45:00"
      eventType: "AwsApiCall"
      eventVersion: "1.09"
      managementEvent: true
      readOnly: false
      recipientAccountId: "123456789012"
      requestID: "non98765-4321-dcba-hgfe-tsrqponmlkji"
      requestParameters:
        userName: "test-user"
      responseElements:
        accessKey:
          accessKeyId: "AKIAIOSFODNN7EXAMPLE"
          status: "Active"
          userName: "test-user"
      sourceIPAddress: "203.0.113.50"
      userAgent: "aws-cli/2.0.0 Python/3.8.5 Linux/5.4.0-48-generic botocore/2.0.0dev0"
      userIdentity:
        type: "IAMUser"
        principalId: "AIDACKCEVSQ6C2EXAMPLE"
        arn: "arn:aws:iam::123456789012:user/admin"
        accountId: "123456789012"
        userName: "admin"

  - Name: "Console Login with Missing Username"
    ExpectedResult: true
    Log:
      awsRegion: "us-east-1"
      eventCategory: "Management"
      eventID: "missing1-2345-6789-abcd-efghijklmnop"
      eventName: "ConsoleLogin"
      eventSource: "signin.amazonaws.com"
      eventTime: "2025-08-13 14:50:00"
      eventType: "AwsConsoleSignIn"
      eventVersion: "1.08"
      recipientAccountId: "123456789012"
      requestID: "missing2-3456-789a-bcde-fghijklmnopq"
      requestParameters: null
      responseElements:
        ConsoleLogin: "Success"
      sourceIPAddress: "192.168.1.100"
      userAgent: "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:89.0) Gecko/20100101 Firefox/89.0"
      userIdentity:
        type: "IAMUser"
        principalId: "AIDACKCEVSQ6C2EXAMPLE"
        arn: "arn:aws:iam::123456789012:user/service-account"
        accountId: "123456789012"

  - Name: "Console Login with Missing Source IP"
    ExpectedResult: true
    Log:
      awsRegion: "us-west-1"
      eventCategory: "Management"
      eventID: "noip1234-5678-9abc-def0-123456789012"
      eventName: "ConsoleLogin"
      eventSource: "signin.amazonaws.com"
      eventTime: "2025-08-13 14:55:00"
      eventType: "AwsConsoleSignIn"
      eventVersion: "1.08"
      recipientAccountId: "123456789012"
      requestID: "noip5678-9abc-def0-1234-56789012345"
      requestParameters: null
      responseElements:
        ConsoleLogin: "Success"
      userAgent: "Mozilla/5.0 (iPad; CPU OS 14_6 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/14.1.1 Mobile/15E148 Safari/604.1"
      userIdentity:
        type: "IAMUser"
        principalId: "AIDACKCEVSQ6C2EXAMPLE"
        arn: "arn:aws:iam::123456789012:user/mobile.user"
        accountId: "123456789012"
        userName: "mobile.user"
