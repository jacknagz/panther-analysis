AnalysisType: rule
DedupPeriodMinutes: 60
LogTypes:
  - AWS.CloudTrail
RuleID: "AWS.EC2.Monitoring.Custom"
Threshold: 1
Description: Checks CloudTrail for occurrences of EC2 Image Actions.
DisplayName: "AWS EC2 Image Monitoring"
Enabled: true
Filename: aws_ec2_monitoring.py
Reports:
  MITRE ATT&CK:
    - TA0002:T1204
Runbook: Verify that the action was not taken by a malicious actor.
Reference: https://docs.aws.amazon.com/service-authorization/latest/reference/list_amazonec2imagebuilder.html#amazonec2imagebuilder-actions-as-permissions
Severity: Info
Tags:
  # Required tags
  - compliance.soc2
  - usecase.configuration_management
  # Optional tags
  - mitre.ta0005.defense_evasion
  - mitre.t1562.impair_defenses
  - asset.detection_controls
  - impact.availability

Tests:
  - Name: CopyImage
    ExpectedResult: true
    Log:
      awsRegion: us-east-1
      eventCategory: Management
      eventID: 0ea3f05a-066c-43f9-8869-393ba67e7936
      eventName: CreateImage
      eventSource: ec2.amazonaws.com
      eventTime: "2022-09-29 22:25:17"
      eventType: AwsApiCall
      eventVersion: "1.08"
      managementEvent: true
      p_any_aws_account_ids:
        - "123456789101"
      p_any_aws_arns:
        - arn:aws:iam::123456789101:role/DevAdministrator
        - arn:aws:sts::123456789101:assumed-role/DevAdministrator/test_user
      p_any_aws_instance_ids:
        - i-0381a3817f72a949d
      p_any_domain_names:
        - AWS Internal
      p_any_trace_ids:
        - ASIA5PZQZ5QHE2FUNXHR
      p_event_time: "2022-09-29 22:25:17"
      p_log_type: AWS.CloudTrail
      p_parse_time: "2022-09-29 22:27:25.748"
      p_row_id: 66011977ec1fd0cf9dacf7d913f08d06
      p_source_id: 125a8146-e3ea-454b-aed7-9e08e735b670
      p_source_label: CloudTrail Logs
      readOnly: false
      recipientAccountId: "123456789101"
      requestID: e686939a-a08a-4fd6-abf5-9ea34793cf25
      requestParameters:
        blockDeviceMapping:
          items:
            - deviceName: /dev/xvda
              ebs:
                deleteOnTermination: true
                volumeSize: 8
        instanceId: i-0381a3817f72a949d
        name: testimage
        noReboot: false
      responseElements:
        imageId: ami-06aaf5e4b77161786
        requestId: e686939a-a08a-4fd6-abf5-9ea34793cf25
      sessionCredentialFromConsole: true
      sourceIPAddress: AWS Internal
      userAgent: AWS Internal
      userIdentity:
        accessKeyId: ASIA5PZQZ5QHE2FUNXHR
        accountId: "123456789101"
        arn: arn:aws:sts::123456789101:assumed-role/DevAdministrator/test_user
        principalId: AROA5PZQZ5QHBULW27VAC:test_user
        sessionContext:
          attributes:
            creationDate: "2022-09-29T22:22:46Z"
            mfaAuthenticated: "true"
          sessionIssuer:
            accountId: "123456789101"
            arn: arn:aws:iam::123456789101:role/DevAdministrator
            principalId: AROA5PZQZ5QHBULW27VAC
            type: Role
            userName: DevAdministrator
          webIdFederationData: {}
        type: AssumedRole
  - Name: EC2 RunInstances Does Not Alert
    ExpectedResult: false
    Log:
      awsRegion: us-east-1
      eventCategory: Management
      eventID: 015c585b-cbc2-4f9e-9c52-a2f22f3c09f4
      eventName: RunInstances
      eventSource: ec2.amazonaws.com
      eventTime: "2022-10-20 14:16:43"
      eventType: AwsApiCall
      eventVersion: "1.08"
      managementEvent: true
      p_any_aws_account_ids:
        - "123123123123"
      p_any_aws_arns:
        - arn:aws:iam::123123123123:role/DevAdministrator
        - arn:aws:sts::123123123123:assumed-role/DevAdministrator/temp_user
      p_any_aws_instance_ids:
        - i-0d7e4b9be8a0de6ea
      p_any_aws_tags:
        - Name:test2
      p_any_domain_names:
        - AWS Internal
        - ip-111.111.111.111.ec2.internal
      p_any_ip_addresses:
        - 111.111.111.111
      p_any_trace_ids:
        - ASIA5PZQZ5QHAW6RFPO5
      p_any_usernames:
        - DevAdministrator
      p_event_time: "2022-10-20 14:16:43"
      p_log_type: AWS.CloudTrail
      p_parse_time: "2022-10-20 14:21:06.845"
      p_row_id: be7b3bed9bb891e4a8b9f38d149909
      p_source_id: 125a8146-e3ea-454b-aed7-9e08e735b670
      p_source_label: Panther Identity Org CloudTrail
      readOnly: false
      recipientAccountId: "123123123123"
      requestID: 25c95576-a825-44fd-971d-5a52c1e3b2be
      requestParameters:
        blockDeviceMapping: {}
        disableApiStop: false
        disableApiTermination: false
        ebsOptimized: false
        instanceType: t1.micro
        instancesSet:
          items:
            - imageId: ami-026b57f3c383c2eec
              keyName: kp1
              maxCount: 1
              minCount: 1
        monitoring:
          enabled: false
        networkInterfaceSet:
          items:
            - associatePublicIpAddress: true
              deviceIndex: 0
              groupSet:
                items:
                  - groupId: sg-0aebfa21f302bded9
        privateDnsNameOptions:
          enableResourceNameDnsAAAARecord: false
          enableResourceNameDnsARecord: true
          hostnameType: ip-name
        tagSpecificationSet:
          items:
            - resourceType: instance
              tags:
                - key: Name
                  value: test2
      responseElements:
        groupSet: {}
        instancesSet:
          items:
            - amiLaunchIndex: 0
              architecture: x86_64
              blockDeviceMapping: {}
              capacityReservationSpecification:
                capacityReservationPreference: open
              cpuOptions:
                coreCount: 1
                threadsPerCore: 1
              currentInstanceBootMode: bios
              ebsOptimized: false
              enaSupport: true
              enclaveOptions:
                enabled: false
              groupSet:
                items:
                  - groupId: sg-0aebfa21f302bded9
                    groupName: launch-wizard-4
              hypervisor: xen
              imageId: ami-026b57f3c383c2eec
              instanceId: i-0d7e4b9be8a0de6ea
              instanceState:
                code: 0
                name: pending
              instanceType: t1.micro
              keyName: kp1
              launchTime: 1.666275403e+12
              maintenanceOptions:
                autoRecovery: default
              metadataOptions:
                httpEndpoint: enabled
                httpProtocolIpv4: enabled
                httpProtocolIpv6: disabled
                httpPutResponseHopLimit: 1
                httpTokens: optional
                instanceMetadataTags:
