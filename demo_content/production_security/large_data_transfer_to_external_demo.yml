AnalysisType: rule
Filename: large_data_transfer_to_external_demo.py
RuleID: "Network.LargeDataTransferToExternal.Demo"
DisplayName: "Large Data Transfer from Internal to External IP"
Enabled: true
LogTypes:
  - AWS.VPCFlow
  - OCSF.NetworkActivity
Severity: High
DedupPeriodMinutes: 60
Description: |
  Detects large data transfers (over 100MB) from internal servers to external IP addresses, which could indicate data exfiltration or unauthorized data movement. Alerts when a single flow record exceeds the threshold and the destination is an external IP.
Runbook: |
  1. Query VPC Flow Logs for all connections from the source IP to external destinations in the 2 hours before and after this transfer to identify patterns
  2. Find CloudTrail activity from the source instance or associated IAM roles in the 6 hours before the transfer to identify potentially malicious API calls
  3. Check if the destination IP is associated with cloud storage providers, file sharing services, or threat intelligence feeds
Reference: https://docs.aws.amazon.com/vpc/latest/userguide/flow-log-records.html
SummaryAttributes:
  - source_ip
  - destination_ip
  - bytes
  - action
  - log_status
Threshold: 1
Tags:
  # Required tags
  - compliance.soc2
  - usecase.insider_threat_detection
  # Optional tags
  - mitre.ta0010.exfiltration
  - mitre.t1537.transfer_data_to_cloud_account
  - threat.insider
  - threat.external
  - impact.confidentiality

Tests:
  - Name: Large Transfer to External
    ExpectedResult: true
    Log:
      p_log_type: AWS.VPCFlow
      srcAddr: 10.0.0.5
      dstAddr: 8.8.8.8
      srcPort: 12345
      dstPort: 443
      bytes: 150000000
      action: ACCEPT
      status: OK
  - Name: Small Transfer to External
    ExpectedResult: false
    Log:
      p_log_type: AWS.VPCFlow
      srcAddr: 10.0.0.5
      dstAddr: 8.8.8.8
      srcPort: 12345
      dstPort: 443
      bytes: 10000
      action: ACCEPT
      status: OK
  - Name: Large Transfer to Internal
    ExpectedResult: false
    Log:
      p_log_type: AWS.VPCFlow
      srcAddr: 10.0.0.5
      dstAddr: 10.0.0.10
      srcPort: 12345
      dstPort: 443
      bytes: 200000000
      action: ACCEPT
      status: OK 