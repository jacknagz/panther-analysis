AnalysisType: rule
Filename: aws_iam_attach_admin_user_policy_demo.py
RuleID: "AWS.IAM.AttachAdminUserPolicy.Demo"
DisplayName: "Sensitive IAM Policy Attached to User (Demo)"
Enabled: true
CreateAlert: false
Severity: Info
LogTypes:
  - AWS.CloudTrail
Reports:
  CIS:
    - 1.1
  MITRE ATT&CK:
    - TA0007:T1078
Tags:
  - demo
  # Service/Platform tags
  - aws.iam
  # Behaviors/Actions tags
  - auth.role_escalation
  - resource.permission_change
  - policy.change
  # Compliance tags
  - compliance.soc2
  - compliance.pci_dss
  - compliance.iso27001
  # MITRE tags
  - privilege_escalation.valid_accounts.default_accounts
  - persistence.account_manipulation.additional_cloud_credentials
Description: >
  Detects when sensitive IAM policies (such as AdministratorAccess or S3FullAccess) are attached to IAM users. 
  These policies grant extensive permissions that could pose significant security risks if misused or compromised.
  Monitoring such policy attachments is crucial for maintaining the principle of least privilege.
Reference: https://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies.html
Tests:
  - Name: IAM User Policy Attached with Administrator Access
    ExpectedResult: true
    Log:
      {
        "awsRegion": "us-east-1",
        "eventCategory": "Management",
        "eventID": "0d339bf1-37e8-492c-8ebb-67b7a0ecd0af",
        "eventName": "AttachUserPolicy",
        "eventSource": "iam.amazonaws.com",
        "eventTime": "2025-04-28 22:57:36.000000000",
        "eventType": "AwsApiCall",
        "eventVersion": "1.10",
        "managementEvent": true,
        "readOnly": false,
        "recipientAccountId": "904233115233",
        "requestID": "96f014bc-4cce-40b5-b2af-905e3a7decb2",
        "requestParameters": {
          "policyArn": "arn:aws:iam::aws:policy/AmazonS3FullAccess",
          "userName": "data-pipeline-svc"
        },
        "sourceIPAddress": "199.115.242.184",
        "tlsDetails": {
          "cipherSuite": "TLS_AES_128_GCM_SHA256",
          "clientProvidedHostHeader": "iam.amazonaws.com",
          "tlsVersion": "TLSv1.3"
        },
        "userAgent": "aws-cli/2.27.0 md/awscrt#0.25.4 ua/2.1 os/macos#24.4.0 md/arch#arm64 lang/python#3.13.3 md/pyimpl#CPython cfg/retry-mode#standard md/installer#source md/prompt#off md/command#iam.attach-user-policy",
        "userIdentity": {
          "accessKeyId": "ASIA5FCD6LZQRPTGM7TD",
          "accountId": "904233115233",
          "arn": "arn:aws:sts::904233115233:assumed-role/AWSReservedSSO_DevAdmin_bdb4a195f9d8fb11/jack",
          "principalId": "AROA5FCD6LZQRCJCL2SCB:jack",
          "sessionContext": {
            "attributes": {
              "creationDate": "2025-04-28T22:46:19Z",
              "mfaAuthenticated": "false"
            },
            "sessionIssuer": {
              "accountId": "904233115233",
              "arn": "arn:aws:iam::904233115233:role/aws-reserved/sso.amazonaws.com/us-west-2/AWSReservedSSO_DevAdmin_bdb4a195f9d8fb11",
              "principalId": "AROA5FCD6LZQRCJCL2SCB",
              "type": "Role",
              "userName": "AWSReservedSSO_DevAdmin_bdb4a195f9d8fb11"
            }
          },
          "type": "AssumedRole"
        }
      }
  - Name: IAM User Policy Attached without Administrator Access
    ExpectedResult: false
    Log:
      {
        "eventVersion": "1.05",
        "userIdentity":
          {
            "type": "AssumedRole",
            "principalId": "tester",
            "arn": "arn:aws:sts::123456789012:assumed-role/tester",
            "accountId": "123456789012",
            "accessKeyId": "1",
            "sessionContext":
              {
                "sessionIssuer":
                  {
                    "type": "Role",
                    "principalId": "1111",
                    "arn": "arn:aws:iam::123456789012:role/tester",
                    "accountId": "123456789012",
                    "userName": "Tester",
                  },
                "webIdFederationData": {},
                "attributes":
                  {
                    "mfaAuthenticated": "true",
                    "creationDate": "2019-01-01T00:00:00Z",
                  },
              },
          },
        "eventTime": "2019-01-01T00:00:00Z",
        "eventSource": "iam.amazonaws.com",
        "eventName": "AttachUserPolicy",
        "awsRegion": "us-west-2",
        "sourceIPAddress": "111.111.111.111",
        "userAgent": "console.amazonaws.com",
        "requestParameters":
          {
            "policyArn": "arn:aws:iam::aws:policy/ReadOnlyAccess",
            "userName": "new-user"
          },
        "responseElements": null,
        "requestID": "1",
        "eventID": "1",
        "readOnly": false,
        "eventType": "AwsApiCall",
        "recipientAccountId": "123456789012",
      }
