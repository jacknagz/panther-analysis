AnalysisType: scheduled_query
QueryName: "IAM Actor Behavioral Baseline Query"
Enabled: false
Description: >
  Creates comprehensive behavioral profiles for each IAM actor by analyzing their privilege
  escalation activities over the past 30 days. Aggregates IAM events into distribution objects
  showing frequency counts across multiple dimensions including event types, target resources,
  source IPs, regions, policies, and risk patterns.
Tags:
  - AI-Optimized
  - Privilege-Escalation
  - Behavior-Baselines
  - IAM-Analysis
Query: |
  WITH base AS (
    SELECT
      userIdentity:arn::string AS actor_arn,
      COALESCE(userIdentity:userName, userIdentity:sessionContext:sessionIssuer:userName, 'unknown')::string AS actor_name,
      userIdentity:type::string AS user_type,
      userIdentity:accountId::string AS account_id,
      eventName,
      sourceIPAddress,
      awsRegion,
      userAgent,
      requestParameters:userName::string AS target_user,
      requestParameters:roleName::string AS target_role,
      requestParameters:groupName::string AS target_group,
      requestParameters:policyArn::string AS policy_arn,
      requestParameters:policyName::string AS policy_name,
      requestParameters:roleArn::string AS assumed_role_arn,
      -- Activity Classification
      CASE
        WHEN eventName IN ('CreateUser', 'CreateRole', 'CreateServiceLinkedRole') THEN 'identity_creation'
        WHEN eventName IN ('AttachUserPolicy', 'AttachRolePolicy', 'PutUserPolicy', 'PutRolePolicy') THEN 'policy_attachment'
        WHEN eventName IN ('DetachUserPolicy', 'DetachRolePolicy', 'DeleteUserPolicy', 'DeleteRolePolicy') THEN 'policy_detachment'
        WHEN eventName IN ('AssumeRole', 'AssumeRoleWithSAML', 'AssumeRoleWithWebIdentity') THEN 'role_assumption'
        WHEN eventName IN ('CreateAccessKey', 'UpdateAccessKey') THEN 'access_key_management'
        WHEN eventName IN ('AddUserToGroup') THEN 'group_membership'
        WHEN eventName IN ('UpdateAssumeRolePolicy') THEN 'trust_policy_modification'
        WHEN eventName IN ('CreatePolicyVersion', 'SetDefaultPolicyVersion') THEN 'policy_version_manipulation'
        WHEN eventName IN ('DeletePermissionsBoundary') THEN 'permissions_boundary_removal'
        WHEN eventName IN ('PutPermissionsBoundary') THEN 'permissions_boundary_addition'
        ELSE 'other_iam'
      END as activity_type,
      HOUR(p_event_time) AS utc_hour
    FROM panther_logs.public.aws_cloudtrail
    WHERE p_occurs_since('30 d')
      AND eventSource = 'iam.amazonaws.com'
      AND eventName IN (
        'CreateUser', 'CreateRole', 'CreateServiceLinkedRole',
        'AttachUserPolicy', 'AttachRolePolicy', 'PutUserPolicy', 'PutRolePolicy',
        'DetachUserPolicy', 'DetachRolePolicy', 'DeleteUserPolicy', 'DeleteRolePolicy',
        'AssumeRole', 'AssumeRoleWithSAML', 'AssumeRoleWithWebIdentity',
        'CreateAccessKey', 'UpdateAccessKey',
        'AddUserToGroup',
        'UpdateAssumeRolePolicy',
        'CreatePolicyVersion', 'SetDefaultPolicyVersion',
        'DeletePermissionsBoundary', 'PutPermissionsBoundary'
      )
      AND errorCode IS NULL
      -- Filter: Only actors with 10+ events (optimization)
      AND userIdentity:arn::string IN (
        SELECT userIdentity:arn::string
        FROM panther_logs.public.aws_cloudtrail
        WHERE p_occurs_since('30 d')
          AND eventSource = 'iam.amazonaws.com'
        GROUP BY userIdentity:arn::string
        HAVING COUNT(*) >= 10
      )
  ),
  -- Event name distribution (top 10)
  event_dist AS (
    SELECT actor_arn, OBJECT_AGG(eventName, cnt) AS event_name_distribution
    FROM (
      SELECT actor_arn, eventName, COUNT(*) AS cnt
      FROM base
      WHERE eventName IS NOT NULL
      GROUP BY actor_arn, eventName
      QUALIFY ROW_NUMBER() OVER (PARTITION BY actor_arn ORDER BY cnt DESC) <= 10
    )
    GROUP BY actor_arn
  ),
  -- Activity type distribution (all types, low cardinality)
  activity_type_dist AS (
    SELECT actor_arn, OBJECT_AGG(activity_type, cnt) AS activity_type_distribution
    FROM (
      SELECT actor_arn, activity_type, COUNT(*) AS cnt
      FROM base
      WHERE activity_type IS NOT NULL
      GROUP BY actor_arn, activity_type
    )
    GROUP BY actor_arn
  ),
  -- Source IP distribution (top 10)
  ip_dist AS (
    SELECT actor_arn, OBJECT_AGG(sourceIPAddress, cnt) AS source_ip_distribution
    FROM (
      SELECT actor_arn, sourceIPAddress, COUNT(*) AS cnt
      FROM base
      WHERE sourceIPAddress IS NOT NULL
      GROUP BY actor_arn, sourceIPAddress
      QUALIFY ROW_NUMBER() OVER (PARTITION BY actor_arn ORDER BY cnt DESC) <= 10
    )
    GROUP BY actor_arn
  ),
  -- Region distribution (top 5)
  region_dist AS (
    SELECT actor_arn, OBJECT_AGG(awsRegion, cnt) AS region_distribution
    FROM (
      SELECT actor_arn, awsRegion, COUNT(*) AS cnt
      FROM base
      WHERE awsRegion IS NOT NULL
      GROUP BY actor_arn, awsRegion
      QUALIFY ROW_NUMBER() OVER (PARTITION BY actor_arn ORDER BY cnt DESC) <= 5
    )
    GROUP BY actor_arn
  ),
  -- Target user distribution (top 10)
  target_user_dist AS (
    SELECT actor_arn, OBJECT_AGG(target_user, cnt) AS target_user_distribution
    FROM (
      SELECT actor_arn, target_user, COUNT(*) AS cnt
      FROM base
      WHERE target_user IS NOT NULL
      GROUP BY actor_arn, target_user
      QUALIFY ROW_NUMBER() OVER (PARTITION BY actor_arn ORDER BY cnt DESC) <= 10
    )
    GROUP BY actor_arn
  ),
  -- Target role distribution (top 10)
  target_role_dist AS (
    SELECT actor_arn, OBJECT_AGG(target_role, cnt) AS target_role_distribution
    FROM (
      SELECT actor_arn, target_role, COUNT(*) AS cnt
      FROM base
      WHERE target_role IS NOT NULL
      GROUP BY actor_arn, target_role
      QUALIFY ROW_NUMBER() OVER (PARTITION BY actor_arn ORDER BY cnt DESC) <= 10
    )
    GROUP BY actor_arn
  ),
  -- Target group distribution (top 10)
  target_group_dist AS (
    SELECT actor_arn, OBJECT_AGG(target_group, cnt) AS target_group_distribution
    FROM (
      SELECT actor_arn, target_group, COUNT(*) AS cnt
      FROM base
      WHERE target_group IS NOT NULL
      GROUP BY actor_arn, target_group
      QUALIFY ROW_NUMBER() OVER (PARTITION BY actor_arn ORDER BY cnt DESC) <= 10
    )
    GROUP BY actor_arn
  ),
  -- Policy ARN distribution (top 10)
  policy_dist AS (
    SELECT actor_arn, OBJECT_AGG(policy_arn, cnt) AS policy_arn_distribution
    FROM (
      SELECT actor_arn, policy_arn, COUNT(*) AS cnt
      FROM base
      WHERE policy_arn IS NOT NULL
      GROUP BY actor_arn, policy_arn
      QUALIFY ROW_NUMBER() OVER (PARTITION BY actor_arn ORDER BY cnt DESC) <= 10
    )
    GROUP BY actor_arn
  ),
  -- Assumed role distribution (top 10)
  assumed_role_dist AS (
    SELECT actor_arn, OBJECT_AGG(assumed_role_arn, cnt) AS assumed_role_distribution
    FROM (
      SELECT actor_arn, assumed_role_arn, COUNT(*) AS cnt
      FROM base
      WHERE assumed_role_arn IS NOT NULL
      GROUP BY actor_arn, assumed_role_arn
      QUALIFY ROW_NUMBER() OVER (PARTITION BY actor_arn ORDER BY cnt DESC) <= 10
    )
    GROUP BY actor_arn
  ),
  -- UTC hour distribution (all 24 hours, low cardinality)
  hour_dist AS (
    SELECT actor_arn, OBJECT_AGG(utc_hour::VARCHAR, cnt) AS utc_hour_distribution
    FROM (
      SELECT actor_arn, utc_hour, COUNT(*) AS cnt
      FROM base
      WHERE utc_hour IS NOT NULL
      GROUP BY actor_arn, utc_hour
    )
    GROUP BY actor_arn
  ),
  -- User agent distribution (top 10)
  user_agent_dist AS (
    SELECT actor_arn, OBJECT_AGG(userAgent, cnt) AS user_agent_distribution
    FROM (
      SELECT actor_arn, userAgent, COUNT(*) AS cnt
      FROM base
      WHERE userAgent IS NOT NULL
      GROUP BY actor_arn, userAgent
      QUALIFY ROW_NUMBER() OVER (PARTITION BY actor_arn ORDER BY cnt DESC) <= 10
    )
    GROUP BY actor_arn
  )
  -- Join all distributions
  SELECT
    ed.actor_arn,
    ANY_VALUE(b.actor_name) as actor_name,
    ANY_VALUE(b.user_type) as user_type,
    ANY_VALUE(b.account_id) as account_id,
    ed.event_name_distribution,
    atd.activity_type_distribution,
    id.source_ip_distribution,
    rd.region_distribution,
    tud.target_user_distribution,
    trold.target_role_distribution,
    tgd.target_group_distribution,
    pd.policy_arn_distribution,
    ard.assumed_role_distribution,
    hd.utc_hour_distribution,
    uad.user_agent_distribution
  FROM event_dist ed
  LEFT JOIN base b ON ed.actor_arn = b.actor_arn
  LEFT JOIN activity_type_dist atd ON ed.actor_arn = atd.actor_arn
  LEFT JOIN ip_dist id ON ed.actor_arn = id.actor_arn
  LEFT JOIN region_dist rd ON ed.actor_arn = rd.actor_arn
  LEFT JOIN target_user_dist tud ON ed.actor_arn = tud.actor_arn
  LEFT JOIN target_role_dist trold ON ed.actor_arn = trold.actor_arn
  LEFT JOIN target_group_dist tgd ON ed.actor_arn = tgd.actor_arn
  LEFT JOIN policy_dist pd ON ed.actor_arn = pd.actor_arn
  LEFT JOIN assumed_role_dist ard ON ed.actor_arn = ard.actor_arn
  LEFT JOIN hour_dist hd ON ed.actor_arn = hd.actor_arn
  LEFT JOIN user_agent_dist uad ON ed.actor_arn = uad.actor_arn
  GROUP BY
    ed.actor_arn,
    ed.event_name_distribution,
    atd.activity_type_distribution,
    id.source_ip_distribution,
    rd.region_distribution,
    tud.target_user_distribution,
    trold.target_role_distribution,
    tgd.target_group_distribution,
    pd.policy_arn_distribution,
    ard.assumed_role_distribution,
    hd.utc_hour_distribution,
    uad.user_agent_distribution
  ORDER BY ed.actor_arn
Schedule:
  RateMinutes: 4320  # 3 days
  TimeoutMinutes: 10