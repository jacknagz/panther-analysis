AnalysisType: rule
Filename: aws_console_login_non_us_demo.py
RuleID: "AWS.Console.LoginNonUS.Demo"
DisplayName: "AWS Console Login from Outside US"
Enabled: true
LogTypes:
  - AWS.CloudTrail
Tags:
  - demo
  - aws.cloudtrail
  - auth.login_success
  - auth.anomalous_location
  - initial_access.valid_accounts
Reports:
  MITRE ATT&CK:
    - TA0001:T1078
Severity: Medium
Description: >
  Detects AWS console login attempts from IP addresses located outside the United States using IPInfo location enrichment data. This may indicate unauthorized access or policy violations that require investigation.
Runbook: >
  1. Verify the legitimacy of the console login attempt
  2. Check if the user has authorized international travel or remote work
  3. Investigate other recent activities by the same user account
  4. Confirm the user identity through out-of-band communication if suspicious
  5. Consider implementing additional access controls for international access
Reference: https://docs.aws.amazon.com/IAM/latest/UserGuide/console.html
SummaryAttributes:
  - sourceIPAddress
  - userAgent
  - recipientAccountId
  - p_any_aws_arns
DedupPeriodMinutes: 60
Tests:
  - Name: Console login from Canada (non-US)
    ExpectedResult: true
    Log:
      eventVersion: "1.05"
      userIdentity:
        type: IAMUser
        principalId: "AIDACKCEVSQ6C2EXAMPLE"
        arn: "arn:aws:iam::123456789012:user/testuser"
        accountId: "123456789012"
        userName: "testuser"
      eventTime: "2024-01-15T10:30:00Z"
      eventSource: "signin.amazonaws.com"
      eventName: "ConsoleLogin"
      awsRegion: "us-east-1"
      sourceIPAddress: "142.59.100.1"
      userAgent: "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"
      requestParameters: null
      responseElements:
        ConsoleLogin: "Success"
      additionalEventData:
        LoginTo: "https://console.aws.amazon.com/console/"
        MobileVersion: "No"
        MFAUsed: "Yes"
      eventID: "12345678-1234-1234-1234-123456789012"
      eventType: "AwsConsoleSignIn"
      recipientAccountId: "123456789012"
      p_enrichment:
        ipinfo_location:
          sourceIPAddress:
            country: "CA"
            city: "Toronto"
            region: "Ontario"
            timezone: "America/Toronto"
            lat: 43.6532
            lng: -79.3832
            postal_code: "M5B"
  - Name: Console login from United Kingdom (non-US)
    ExpectedResult: true
    Log:
      eventVersion: "1.05"
      userIdentity:
        type: Root
        principalId: "123456789012"
        arn: "arn:aws:iam::123456789012:root"
        accountId: "123456789012"
      eventTime: "2024-01-15T14:20:00Z"
      eventSource: "signin.amazonaws.com"
      eventName: "ConsoleLogin"
      awsRegion: "us-east-1"
      sourceIPAddress: "81.2.69.142"
      userAgent: "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7)"
      requestParameters: null
      responseElements:
        ConsoleLogin: "Success"
      additionalEventData:
        LoginTo: "https://console.aws.amazon.com/console/"
        MobileVersion: "No"
        MFAUsed: "No"
      eventID: "87654321-4321-4321-4321-210987654321"
      eventType: "AwsConsoleSignIn"
      recipientAccountId: "123456789012"
      p_enrichment:
        ipinfo_location:
          sourceIPAddress:
            country: "GB"
            city: "London"
            region: "England"
            timezone: "Europe/London"
            lat: 51.5074
            lng: -0.1278
            postal_code: "EC1A"
  - Name: Console login from US (should not alert)
    ExpectedResult: false
    Log:
      eventVersion: "1.05"
      userIdentity:
        type: IAMUser
        principalId: "AIDACKCEVSQ6C2EXAMPLE"
        arn: "arn:aws:iam::123456789012:user/testuser"
        accountId: "123456789012"
        userName: "testuser"
      eventTime: "2024-01-15T16:45:00Z"
      eventSource: "signin.amazonaws.com"
      eventName: "ConsoleLogin"
      awsRegion: "us-east-1"
      sourceIPAddress: "54.240.196.100"
      userAgent: "Mozilla/5.0 (Windows NT 10.0; Win64; x64)"
      requestParameters: null
      responseElements:
        ConsoleLogin: "Success"
      additionalEventData:
        LoginTo: "https://console.aws.amazon.com/console/"
        MobileVersion: "No"
        MFAUsed: "Yes"
      eventID: "11223344-5566-7788-9900-112233445566"
      eventType: "AwsConsoleSignIn"
      recipientAccountId: "123456789012"
      p_enrichment:
        ipinfo_location:
          sourceIPAddress:
            country: "US"
            city: "Seattle"
            region: "Washington"
            timezone: "America/Los_Angeles"
            lat: 47.6062
            lng: -122.3321
            postal_code: "98101"
  - Name: Failed console login from non-US (should not alert)
    ExpectedResult: false
    Log:
      eventVersion: "1.05"
      userIdentity:
        type: IAMUser
        principalId: "AIDACKCEVSQ6C2EXAMPLE"
        arn: "arn:aws:iam::123456789012:user/testuser"
        accountId: "123456789012"
        userName: "testuser"
      eventTime: "2024-01-15T12:15:00Z"
      eventSource: "signin.amazonaws.com"
      eventName: "ConsoleLogin"
      awsRegion: "us-east-1"
      sourceIPAddress: "195.154.1.1"
      userAgent: "Mozilla/5.0 (X11; Linux x86_64)"
      requestParameters: null
      responseElements:
        ConsoleLogin: "Failure"
      additionalEventData:
        LoginTo: "https://console.aws.amazon.com/console/"
        MobileVersion: "No"
        MFAUsed: "No"
      eventID: "99887766-5544-3322-1100-998877665544"
      eventType: "AwsConsoleSignIn"
      recipientAccountId: "123456789012"
      p_enrichment:
        ipinfo_location:
          sourceIPAddress:
            country: "FR"
            city: "Paris"
            region: "ÃŽle-de-France"
            timezone: "Europe/Paris"
            lat: 48.8566
            lng: 2.3522
            postal_code: "75001"
  - Name: Non-ConsoleLogin event (should not alert)
    ExpectedResult: false
    Log:
      eventVersion: "1.05"
      userIdentity:
        type: IAMUser
        principalId: "AIDACKCEVSQ6C2EXAMPLE"
        arn: "arn:aws:iam::123456789012:user/testuser"
        accountId: "123456789012"
        userName: "testuser"
      eventTime: "2024-01-15T13:30:00Z"
      eventSource: "iam.amazonaws.com"
      eventName: "ListUsers"
      awsRegion: "us-east-1"
      sourceIPAddress: "203.0.113.1"
      userAgent: "aws-cli/2.1.34"
      requestParameters:
        maxItems: 100
      responseElements: null
      eventID: "55443322-1100-9988-7766-554433221100"
      eventType: "AwsApiCall"
      recipientAccountId: "123456789012"
      p_enrichment:
        ipinfo_location:
          sourceIPAddress:
            country: "AU"
            city: "Sydney"
            region: "New South Wales"
            timezone: "Australia/Sydney"
            lat: -33.8688
            lng: 151.2093
            postal_code: "2000"
  - Name: Console login without location enrichment (should not alert)
    ExpectedResult: false
    Log:
      eventVersion: "1.05"
      userIdentity:
        type: IAMUser
        principalId: "AIDACKCEVSQ6C2EXAMPLE"
        arn: "arn:aws:iam::123456789012:user/testuser"
        accountId: "123456789012"
        userName: "testuser"
      eventTime: "2024-01-15T09:00:00Z"
      eventSource: "signin.amazonaws.com"
      eventName: "ConsoleLogin"
      awsRegion: "us-east-1"
      sourceIPAddress: "10.0.1.100"
      userAgent: "Mozilla/5.0 (Windows NT 10.0; Win64; x64)"
      requestParameters: null
      responseElements:
        ConsoleLogin: "Success"
      additionalEventData:
        LoginTo: "https://console.aws.amazon.com/console/"
        MobileVersion: "No"
        MFAUsed: "Yes"
      eventID: "66778899-0011-2233-4455-667788990011"
      eventType: "AwsConsoleSignIn"
      recipientAccountId: "123456789012"
