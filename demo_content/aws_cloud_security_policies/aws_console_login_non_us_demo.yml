AnalysisType: rule
Filename: aws_console_login_non_us_demo.py
RuleID: "AWS.Console.LoginOutsideCA.Demo"
DisplayName: "AWS Console Login from Outside California"
Enabled: true
LogTypes:
  - AWS.CloudTrail
Tags:
  - demo
  - aws.cloudtrail
  - auth.login_success
  - auth.anomalous_location
  - initial_access.valid_accounts
Reports:
  MITRE ATT&CK:
    - TA0001:T1078
Severity: Medium
Description: >
  Detects AWS console login attempts from IP addresses located outside California using IPInfo location enrichment data. This may indicate unauthorized access, travel, or policy violations that require investigation.
Runbook: |
  1. Verify the legitimacy of the console login attempt
  2. Check if the user has authorized international travel or remote work
  3. Investigate other recent activities by the same user account
  4. Confirm the user identity through out-of-band communication if suspicious
  5. Consider implementing additional access controls for international access
Reference: https://docs.aws.amazon.com/IAM/latest/UserGuide/console.html
SummaryAttributes:
  - sourceIPAddress
  - userAgent
  - recipientAccountId
  - p_any_aws_arns
DedupPeriodMinutes: 60
Tests:
  - Name: Console login from New York (outside California)
    ExpectedResult: true
    Log:
      eventVersion: "1.05"
      userIdentity:
        type: IAMUser
        principalId: "AIDACKCEVSQ6C2EXAMPLE"
        arn: "arn:aws:iam::123456789012:user/testuser"
        accountId: "123456789012"
        userName: "testuser"
      eventTime: "2024-01-15T10:30:00Z"
      eventSource: "signin.amazonaws.com"
      eventName: "ConsoleLogin"
      awsRegion: "us-east-1"
      sourceIPAddress: "208.180.20.97"
      userAgent: "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"
      requestParameters: null
      responseElements:
        ConsoleLogin: "Success"
      additionalEventData:
        LoginTo: "https://console.aws.amazon.com/console/"
        MobileVersion: "No"
        MFAUsed: "Yes"
      eventID: "12345678-1234-1234-1234-123456789012"
      eventType: "AwsConsoleSignIn"
      recipientAccountId: "123456789012"
      p_enrichment:
        ipinfo_location:
          sourceIPAddress:
            country: "US"
            city: "New York"
            region: "New York"
            timezone: "America/New_York"
            lat: 40.7128
            lng: -74.0060
            postal_code: "10001"
  - Name: Console login from Texas (outside California)
    ExpectedResult: true
    Log:
      eventVersion: "1.05"
      userIdentity:
        type: Root
        principalId: "123456789012"
        arn: "arn:aws:iam::123456789012:root"
        accountId: "123456789012"
      eventTime: "2024-01-15T14:20:00Z"
      eventSource: "signin.amazonaws.com"
      eventName: "ConsoleLogin"
      awsRegion: "us-east-1"
      sourceIPAddress: "198.27.64.1"
      userAgent: "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7)"
      requestParameters: null
      responseElements:
        ConsoleLogin: "Success"
      additionalEventData:
        LoginTo: "https://console.aws.amazon.com/console/"
        MobileVersion: "No"
        MFAUsed: "No"
      eventID: "87654321-4321-4321-4321-210987654321"
      eventType: "AwsConsoleSignIn"
      recipientAccountId: "123456789012"
      p_enrichment:
        ipinfo_location:
          sourceIPAddress:
            country: "US"
            city: "Austin"
            region: "Texas"
            timezone: "America/Chicago"
            lat: 30.2672
            lng: -97.7431
            postal_code: "73301"
  - Name: Console login from Canada (outside California)
    ExpectedResult: true
    Log:
      eventVersion: "1.05"
      userIdentity:
        type: IAMUser
        principalId: "AIDACKCEVSQ6C2EXAMPLE"
        arn: "arn:aws:iam::123456789012:user/testuser"
        accountId: "123456789012"
        userName: "testuser"
      eventTime: "2024-01-15T18:30:00Z"
      eventSource: "signin.amazonaws.com"
      eventName: "ConsoleLogin"
      awsRegion: "us-east-1"
      sourceIPAddress: "142.59.100.1"
      userAgent: "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"
      requestParameters: null
      responseElements:
        ConsoleLogin: "Success"
      additionalEventData:
        LoginTo: "https://console.aws.amazon.com/console/"
        MobileVersion: "No"
        MFAUsed: "Yes"
      eventID: "11112222-3333-4444-5555-666677778888"
      eventType: "AwsConsoleSignIn"
      recipientAccountId: "123456789012"
      p_enrichment:
        ipinfo_location:
          sourceIPAddress:
            country: "CA"
            city: "Toronto"
            region: "Ontario"
            timezone: "America/Toronto"
            lat: 43.6532
            lng: -79.3832
            postal_code: "M5B"
  - Name: Console login from California (should not alert)
    ExpectedResult: false
    Log:
      eventVersion: "1.05"
      userIdentity:
        type: IAMUser
        principalId: "AIDACKCEVSQ6C2EXAMPLE"
        arn: "arn:aws:iam::123456789012:user/testuser"
        accountId: "123456789012"
        userName: "testuser"
      eventTime: "2024-01-15T16:45:00Z"
      eventSource: "signin.amazonaws.com"
      eventName: "ConsoleLogin"
      awsRegion: "us-east-1"
      sourceIPAddress: "50.145.40.82"
      userAgent: "Mozilla/5.0 (Windows NT 10.0; Win64; x64)"
      requestParameters: null
      responseElements:
        ConsoleLogin: "Success"
      additionalEventData:
        LoginTo: "https://console.aws.amazon.com/console/"
        MobileVersion: "No"
        MFAUsed: "Yes"
      eventID: "11223344-5566-7788-9900-112233445566"
      eventType: "AwsConsoleSignIn"
      recipientAccountId: "123456789012"
      p_enrichment:
        ipinfo_location:
          sourceIPAddress:
            country: "US"
            city: "San Francisco"
            region: "California"
            timezone: "America/Los_Angeles"
            lat: 37.7749
            lng: -122.4194
            postal_code: "94102"
  - Name: Failed console login from outside California (should not alert)
    ExpectedResult: false
    Log:
      eventVersion: "1.05"
      userIdentity:
        type: IAMUser
        principalId: "AIDACKCEVSQ6C2EXAMPLE"
        arn: "arn:aws:iam::123456789012:user/testuser"
        accountId: "123456789012"
        userName: "testuser"
      eventTime: "2024-01-15T12:15:00Z"
      eventSource: "signin.amazonaws.com"
      eventName: "ConsoleLogin"
      awsRegion: "us-east-1"
      sourceIPAddress: "69.46.86.1"
      userAgent: "Mozilla/5.0 (X11; Linux x86_64)"
      requestParameters: null
      responseElements:
        ConsoleLogin: "Failure"
      additionalEventData:
        LoginTo: "https://console.aws.amazon.com/console/"
        MobileVersion: "No"
        MFAUsed: "No"
      eventID: "99887766-5544-3322-1100-998877665544"
      eventType: "AwsConsoleSignIn"
      recipientAccountId: "123456789012"
      p_enrichment:
        ipinfo_location:
          sourceIPAddress:
            country: "US"
            city: "Denver"
            region: "Colorado"
            timezone: "America/Denver"
            lat: 39.7392
            lng: -104.9903
            postal_code: "80202"
  - Name: Non-ConsoleLogin event from outside California (should not alert)
    ExpectedResult: false
    Log:
      eventVersion: "1.05"
      userIdentity:
        type: IAMUser
        principalId: "AIDACKCEVSQ6C2EXAMPLE"
        arn: "arn:aws:iam::123456789012:user/testuser"
        accountId: "123456789012"
        userName: "testuser"
      eventTime: "2024-01-15T13:30:00Z"
      eventSource: "iam.amazonaws.com"
      eventName: "ListUsers"
      awsRegion: "us-east-1"
      sourceIPAddress: "72.229.28.185"
      userAgent: "aws-cli/2.1.34"
      requestParameters:
        maxItems: 100
      responseElements: null
      eventID: "55443322-1100-9988-7766-554433221100"
      eventType: "AwsApiCall"
      recipientAccountId: "123456789012"
      p_enrichment:
        ipinfo_location:
          sourceIPAddress:
            country: "US"
            city: "Phoenix"
            region: "Arizona"
            timezone: "America/Phoenix"
            lat: 33.4484
            lng: -112.0740
            postal_code: "85001"
  - Name: Console login without location enrichment (should not alert)
    ExpectedResult: false
    Log:
      eventVersion: "1.05"
      userIdentity:
        type: IAMUser
        principalId: "AIDACKCEVSQ6C2EXAMPLE"
        arn: "arn:aws:iam::123456789012:user/testuser"
        accountId: "123456789012"
        userName: "testuser"
      eventTime: "2024-01-15T09:00:00Z"
      eventSource: "signin.amazonaws.com"
      eventName: "ConsoleLogin"
      awsRegion: "us-east-1"
      sourceIPAddress: "10.0.1.100"
      userAgent: "Mozilla/5.0 (Windows NT 10.0; Win64; x64)"
      requestParameters: null
      responseElements:
        ConsoleLogin: "Success"
      additionalEventData:
        LoginTo: "https://console.aws.amazon.com/console/"
        MobileVersion: "No"
        MFAUsed: "Yes"
      eventID: "66778899-0011-2233-4455-667788990011"
      eventType: "AwsConsoleSignIn"
      recipientAccountId: "123456789012"
  - Name: AssumedRole console login from outside California (should alert)
    ExpectedResult: true
    Log:
      additionalEventData:
        MobileVersion: "No"
        MFAUsed: "No"
      awsRegion: "us-west-2"
      eventCategory: "Management"
      eventID: "4f5e8637-849c-4980-88ff-3751acd152dd"
      eventName: "ConsoleLogin"
      eventSource: "signin.amazonaws.com"
      eventTime: "2025-09-22 19:19:45.000000000"
      eventType: "AwsConsoleSignIn"
      eventVersion: "1.11"
      managementEvent: true
      readOnly: false
      recipientAccountId: "904233115233"
      responseElements:
        ConsoleLogin: "Success"
      sourceIPAddress: "96.255.35.171"
      tlsDetails:
        tlsVersion: "TLSv1.3"
        cipherSuite: "TLS_AES_128_GCM_SHA256"
        clientProvidedHostHeader: "us-west-2.signin.aws.amazon.com"
      userAgent: "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/140.0.0.0 Safari/537.36"
      userIdentity:
        type: "AssumedRole"
        principalId: "AROA5FCD6LZQZLIF36AWU:russell.leighton"
        arn: "arn:aws:sts::904233115233:assumed-role/AWSReservedSSO_DevAdmin_6605c563ac4b0410/russell.leighton"
        accountId: "904233115233"
        accessKeyId: "ASIA5FCD6LZQ74Z7AFWR"
        sessionContext:
          attributes:
            mfaAuthenticated: "false"
            creationDate: "2025-09-22T19:19:44Z"
          sessionIssuer:
            type: "Role"
            principalId: "AROA5FCD6LZQZLIF36AWU"
            arn: "arn:aws:iam::904233115233:role/aws-reserved/sso.amazonaws.com/us-west-2/AWSReservedSSO_DevAdmin_6605c563ac4b0410"
            accountId: "904233115233"
            userName: "AWSReservedSSO_DevAdmin_6605c563ac4b0410"
      p_enrichment:
        ipinfo_location:
          sourceIPAddress:
            country: "US"
            city: "New York"
            region: "New York"
            timezone: "America/New_York"
            lat: 40.7128
            lng: -74.0060
            postal_code: "10001"
