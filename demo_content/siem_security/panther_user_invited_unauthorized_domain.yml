AnalysisType: rule
RuleID: "Panther.User.Invited.UnauthorizedDomain"
DisplayName: User Invited with Unauthorized Email Domain
Enabled: true
LogTypes:
  - Panther.Audit
Severity: Medium
CreateAlert: true
Description: >
  Detects when a user is invited to Panther with an email domain that is not panther.com or panther.io. 
  This may indicate a potential security risk or violation of email domain policies.
Runbook: >
  1. Review the actor who invited the user and confirm if the invitation was expected and authorized.
  2. Verify if the invited user's email domain should be allowed access to Panther.
  3. Check if this represents a legitimate business need or a potential security risk.
  4. If unauthorized, disable the account immediately and investigate for policy violations.
  5. Consider updating email domain allowlists if this is a legitimate business requirement.
Reference: https://docs.panther.com/system-configuration/panther-audit-logs
SummaryAttributes:
  - actor.name
  - actor.id
  - actionParams
  - sourceIP
  - timestamp
AlertTitle: "User invited with unauthorized domain from [{actor.name}]"
Tags:
  - security_policy_violation
  - compliance.access_control
  - compliance.soc2
  - compliance.change_management
  - mitre.ta0003.persistence
  - usecase.authentication_monitoring
  - usecase.privileged_access_monitoring
  - asset.identity_management
  - threat.insider
  - risk.medium
Detection:
  - KeyPath: actionName
    Condition: Equals
    Value: CREATE_USER
  - KeyPath: actionDescription
    Condition: Equals
    Value: Invites a new user
  - KeyPath: actor.name
    Condition: DoesNotEqual
    Value: System
  - KeyPath: actionResult
    Condition: Equals
    Value: SUCCEEDED
  - KeyPath: actionParams
    Condition: DoesNotContain
    Value: "@panther.com"
  - KeyPath: actionParams
    Condition: DoesNotContain
    Value: "@panther.io"
GroupBy:
  - KeyPath: actor.name
DedupPeriodMinutes: 60
Threshold: 1
Tests:
  - Name: User invited with unauthorized domain (positive)
    ExpectedResult: true
    Log:
      actionName: CREATE_USER
      actionDescription: Invites a new user
      actionResult: SUCCEEDED
      actor:
        id: PantherSSO_admin@panther.com
        name: admin@panther.com
        type: USER
      actionParams: "email=contractor@external.com,role=Analyst"
      sourceIP: 76.137.197.238
      timestamp: "2025-09-16T12:00:00.000Z"
      userAgent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/135.0.0.0 Safari/537.36
      p_log_type: Panther.Audit
  - Name: User invited with panther.com domain (negative)
    ExpectedResult: false
    Log:
      actionName: CREATE_USER
      actionDescription: Invites a new user
      actionResult: SUCCEEDED
      actor:
        id: PantherSSO_admin@panther.com
        name: admin@panther.com
        type: USER
      actionParams: "email=newuser@panther.com,role=Analyst"
      sourceIP: 76.137.197.238
      timestamp: "2025-09-16T12:00:00.000Z"
      userAgent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/135.0.0.0 Safari/537.36
      p_log_type: Panther.Audit
  - Name: User invited with panther.io domain (negative)
    ExpectedResult: false
    Log:
      actionName: CREATE_USER
      actionDescription: Invites a new user
      actionResult: SUCCEEDED
      actor:
        id: PantherSSO_admin@panther.io
        name: admin@panther.io
        type: USER
      actionParams: "email=newuser@panther.io,role=Analyst"
      sourceIP: 76.137.197.238
      timestamp: "2025-09-16T12:00:00.000Z"
      userAgent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/135.0.0.0 Safari/537.36
      p_log_type: Panther.Audit
  - Name: System user creation (negative)
    ExpectedResult: false
    Log:
      actionName: CREATE_USER
      actionDescription: User created automatically by Single Sign-On.
      actionResult: SUCCEEDED
      actor:
        id: 00000000-0000-4000-8000-000000000000
        name: System
        type: USER
      actionParams: "email=ssouser@external.com"
      sourceIP: ""
      timestamp: "2025-09-16T12:00:00.000Z"
      p_log_type: Panther.Audit
