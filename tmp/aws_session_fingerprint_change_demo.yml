AnalysisType: rule
Description: Detects when the same AWS session uses different IP/User-Agent combinations, indicating potential stolen session credentials or session hijacking
DisplayName: AWS Session Fingerprint Change
Enabled: true
Filename: aws_session_fingerprint_change_demo.py
LogTypes:
  - AWS.CloudTrail
RuleID: AWS.Session.Fingerprint.Change.Demo
Severity: Medium
Tags:
  - AWS
  - CloudTrail
  - Credential Theft
  - Session Hijacking
  - MITRE ATT&CK:T1078
  - MITRE ATT&CK:T1550
  - Behavioral Analysis
DedupPeriodMinutes: 60
Threshold: 1
Tests:
  - Name: Session fingerprint change - CLI to Console
    ExpectedResult: true
    Log:
      awsRegion: us-east-1
      eventName: ListUsers
      eventSource: iam.amazonaws.com
      eventTime: "2023-07-22 20:49:05"
      eventVersion: "1.08"
      recipientAccountId: "904233115233"
      sourceIPAddress: "50.145.40.82"
      userAgent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/138.0.0.0 Safari/537.36
      userIdentity:
        type: AssumedRole
        principalId: AROABC123DEFGHIJKLMN:jack
        arn: arn:aws:sts::904233115233:assumed-role/AWSReservedSSO_DevAdmin_bdb4a195f9d8fb11/jack
        accountId: "904233115233"
        accessKeyId: ASIABC123DEFGHIJKLMN
        sessionContext:
          sessionIssuer:
            type: Role
            principalId: AROABC123DEFGHIJKLMN
            arn: arn:aws:iam::904233115233:role/aws-reserved/sso.amazonaws.com/AWSReservedSSO_DevAdmin_bdb4a195f9d8fb11
          webIdFederationData: {}
          attributes:
            mfaAuthenticated: "false"
            creationDate: "2023-07-22T20:30:00Z"

  - Name: Session fingerprint change - Console to CLI
    ExpectedResult: true
    Log:
      awsRegion: us-east-1
      eventName: CreateSecret
      eventSource: secretsmanager.amazonaws.com
      eventTime: "2023-07-22 20:50:24"
      eventVersion: "1.08"
      recipientAccountId: "904233115233"
      sourceIPAddress: "50.145.40.82"
      userAgent: aws-cli/2.27.50 md/awscrt#0.26.1 ua/2.1 os/macos#24.5.0 md/arch#arm64 lang/python#3.13.5 md/pyimpl#CPython m/Z,E,b cfg/retry-mode#standard md/installer#source md/prompt#off md/command#secretsmanager.create-secret
      userIdentity:
        type: AssumedRole
        principalId: AROABC123DEFGHIJKLMN:jack
        arn: arn:aws:sts::904233115233:assumed-role/AWSReservedSSO_DevAdmin_bdb4a195f9d8fb11/jack
        accountId: "904233115233"
        accessKeyId: ASIABC123DEFGHIJKLMN
        sessionContext:
          sessionIssuer:
            type: Role
            principalId: AROABC123DEFGHIJKLMN
            arn: arn:aws:iam::904233115233:role/aws-reserved/sso.amazonaws.com/AWSReservedSSO_DevAdmin_bdb4a195f9d8fb11
          webIdFederationData: {}
          attributes:
            mfaAuthenticated: "false"
            creationDate: "2023-07-22T20:30:00Z"

  - Name: Same fingerprint - no alert
    ExpectedResult: false
    Log:
      awsRegion: us-east-1
      eventName: ListUsers
      eventSource: iam.amazonaws.com
      eventTime: "2023-07-22 20:48:42"
      eventVersion: "1.08"
      recipientAccountId: "904233115233"
      sourceIPAddress: "50.145.40.82"
      userAgent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/138.0.0.0 Safari/537.36
      userIdentity:
        type: AssumedRole
        principalId: AROABC123DEFGHIJKLMN:jack
        arn: arn:aws:sts::904233115233:assumed-role/AWSReservedSSO_DevAdmin_bdb4a195f9d8fb11/jack
        accountId: "904233115233"
        accessKeyId: ASIABC123DEFGHIJKLMN
        sessionContext:
          sessionIssuer:
            type: Role
            principalId: AROABC123DEFGHIJKLMN
            arn: arn:aws:iam::904233115233:role/aws-reserved/sso.amazonaws.com/AWSReservedSSO_DevAdmin_bdb4a195f9d8fb11
          webIdFederationData: {}
          attributes:
            mfaAuthenticated: "false"
            creationDate: "2023-07-22T20:30:00Z"

  - Name: AWS Service call - no alert
    ExpectedResult: false
    Log:
      awsRegion: us-east-1
      eventName: AssumeRole
      eventSource: sts.amazonaws.com
      eventTime: "2023-07-22 20:50:00"
      eventVersion: "1.08"
      recipientAccountId: "904233115233"
      sourceIPAddress: "lambda.amazonaws.com"
      userAgent: "lambda.amazonaws.com"
      userIdentity:
        type: AWSService
        invokedBy: "lambda.amazonaws.com"

  - Name: IAM User with access key - fingerprint change
    ExpectedResult: true
    Log:
      awsRegion: us-east-1
      eventName: CreateUser
      eventSource: iam.amazonaws.com
      eventTime: "2023-07-22 20:40:41"
      eventVersion: "1.08"
      recipientAccountId: "904233115233"
      sourceIPAddress: "192.168.1.100"
      userAgent: aws-cli/2.27.50 md/awscrt#0.26.1 ua/2.1 os/linux#5.15.0 md/arch#x86_64 lang/python#3.11.0
      userIdentity:
        type: IAMUser
        principalId: AIDABC123DEFGHIJKLMN
        arn: arn:aws:iam::904233115233:user/testuser
        accountId: "904233115233"
        accessKeyId: AKIABC123DEFGHIJKLMN
        userName: testuser

  - Name: Different session - no alert
    ExpectedResult: false
    Log:
      awsRegion: us-east-1
      eventName: ListUsers
      eventSource: iam.amazonaws.com
      eventTime: "2023-07-22 21:00:00"
      eventVersion: "1.08"
      recipientAccountId: "904233115233"
      sourceIPAddress: "50.145.40.82"
      userAgent: aws-cli/2.27.50 md/awscrt#0.26.1 ua/2.1 os/macos#24.5.0 md/arch#arm64 lang/python#3.13.5
      userIdentity:
        type: AssumedRole
        principalId: AROABC123DEFGHIJKLMN:alice
        arn: arn:aws:sts::904233115233:assumed-role/AWSReservedSSO_DevAdmin_bdb4a195f9d8fb11/alice
        accountId: "904233115233"
        accessKeyId: ASIABC123DEFGHIJKLMN
        sessionContext:
          sessionIssuer:
            type: Role
            principalId: AROABC123DEFGHIJKLMN
            arn: arn:aws:iam::904233115233:role/aws-reserved/sso.amazonaws.com/AWSReservedSSO_DevAdmin_bdb4a195f9d8fb11
          webIdFederationData: {}
          attributes:
            mfaAuthenticated: "false"
            creationDate: "2023-07-22T20:55:00Z"