AnalysisType: rule
Filename: aws_secretsmanager_retrieve_secrets.py
RuleID: "AWS.SecretsManager.RetrieveSecrets"
DisplayName: "EC2 Secrets Manager Retrieve Secrets"
Enabled: true
LogTypes:
  - AWS.CloudTrail
Tags:
  - Secret Access
  - Secret Management
Reports:
  MITRE ATT&CK:
    - TA0006:T1552 # Credentials from Password Stores 
Severity: Low
Description: >
  An attacker attempted to retrieve a high number of Secrets Manager secrets, through secretsmanager:GetSecretValue.
Runbook: Understand which secrets are being retrieved and why.
Reference: "https://stratus-red-team.cloud/attack-techniques/AWS/aws.credential-access.secretsmanager-retrieve-secrets/"
Threshold: 1
DedupPeriodMinutes: 60 # 1 hour
Tests:
  - Name: 7 unique secrets triggers alert
    ExpectedResult: true
    Mocks:
      - objectName: add_to_string_set
        returnValue: '["arn:aws:secretsmanager:us-west-2:123123123123:secret:secret1","arn:aws:secretsmanager:us-west-2:123123123123:secret:secret2","arn:aws:secretsmanager:us-west-2:123123123123:secret:secret3","arn:aws:secretsmanager:us-west-2:123123123123:secret:secret4","arn:aws:secretsmanager:us-west-2:123123123123:secret:secret5","arn:aws:secretsmanager:us-west-2:123123123123:secret:secret6","arn:aws:secretsmanager:us-west-2:123123123123:secret:secret7"]'
    Log:
      awsRegion: us-west-2
      eventCategory: Management
      eventID: "dfd6d93a-2ce6-4dbe-8939-86b8ba67c868"
      eventName: GetSecretValue
      eventSource: secretsmanager.amazonaws.com
      eventTime: "2024-10-17 21:48:45.000000000"
      eventType: AwsApiCall
      eventVersion: "1.09"
      managementEvent: true
      readOnly: true
      recipientAccountId: "123123123123"
      requestParameters:
        secretId: "arn:aws:secretsmanager:us-west-2:123123123123:secret:secret7"
      sourceIPAddress: "123.123.123.123"
      tlsDetails:
        cipherSuite: "TLS_AES_128_GCM_SHA256"
        clientProvidedHostHeader: "secretsmanager.us-west-2.amazonaws.com"
        tlsVersion: "TLSv1.3"
      userAgent: "aws-cli/2.0"
      userIdentity:
        accessKeyId: "ASIASXP6SDP2LKLKYYC4"
        accountId: "123123123123"
        arn: "arn:aws:sts::123123123123:assumed-role/AWSReservedSSO_DevAdmin_635426549a280cc6/evil.genius"
        principalId: "AROASXP6SDP2F4WLQVARB:evil.genius"
        type: "AssumedRole"
        sessionContext:
          attributes:
            creationDate: "2024-10-17T21:48:13Z"
            mfaAuthenticated: "false"
          sessionIssuer:
            accountId: "123123123123"
            arn: "arn:aws:iam::123123123123:role/aws-reserved/sso.amazonaws.com/us-west-2/AWSReservedSSO_DevAdmin_635426549a280cc6"
            principalId: "AROASXP6SDP2F4WLQVARB"
            type: "Role"
            userName: "AWSReservedSSO_DevAdmin_635426549a280cc6"
  - Name: 6 unique secrets does not trigger alert
    ExpectedResult: false
    Mocks:
      - objectName: add_to_string_set
        returnValue: '["arn:aws:secretsmanager:us-west-2:123123123123:secret:secret1","arn:aws:secretsmanager:us-west-2:123123123123:secret:secret2","arn:aws:secretsmanager:us-west-2:123123123123:secret:secret3","arn:aws:secretsmanager:us-west-2:123123123123:secret:secret4","arn:aws:secretsmanager:us-west-2:123123123123:secret:secret5","arn:aws:secretsmanager:us-west-2:123123123123:secret:secret6"]'
    Log:
      awsRegion: us-west-2
      eventCategory: Management
      eventID: "dfd6d93a-2ce6-4dbe-8939-86b8ba67c868"
      eventName: GetSecretValue
      eventSource: secretsmanager.amazonaws.com
      eventTime: "2024-10-17 21:48:45.000000000"
      eventType: AwsApiCall
      eventVersion: "1.09"
      managementEvent: true
      readOnly: true
      recipientAccountId: "123123123123"
      requestParameters:
        secretId: "arn:aws:secretsmanager:us-west-2:123123123123:secret:secret6"
      sourceIPAddress: "123.123.123.123"
      tlsDetails:
        cipherSuite: "TLS_AES_128_GCM_SHA256"
        clientProvidedHostHeader: "secretsmanager.us-west-2.amazonaws.com"
        tlsVersion: "TLSv1.3"
      userAgent: "aws-cli/2.0"
      userIdentity:
        accessKeyId: "ASIASXP6SDP2LKLKYYC4"
        accountId: "123123123123"
        arn: "arn:aws:sts::123123123123:assumed-role/AWSReservedSSO_DevAdmin_635426549a280cc6/evil.genius"
        principalId: "AROASXP6SDP2F4WLQVARB:evil.genius"
        sessionContext:
          attributes:
            creationDate: "2024-10-17T21:48:13Z"
            mfaAuthenticated: "false"
          sessionIssuer:
            accountId: "123123123123"
            arn: "arn:aws:iam::123123123123:role/aws-reserved/sso.amazonaws.com/us-west-2/AWSReservedSSO_DevAdmin_635426549a280cc6"
            principalId: "AROASXP6SDP2F4WLQVARB"
            type: "Role"
            userName: "AWSReservedSSO_DevAdmin_635426549a280cc6"
        type: "AssumedRole"
  - Name: Repeated attempts on same secret do not trigger alert
    ExpectedResult: false
    Mocks:
      - objectName: add_to_string_set
        returnValue: '["arn:aws:secretsmanager:us-west-2:123123123123:secret:secret1"]'
    Log:
      awsRegion: us-west-2
      eventCategory: Management
      eventID: "dfd6d93a-2ce6-4dbe-8939-86b8ba67c868"
      eventName: GetSecretValue
      eventSource: secretsmanager.amazonaws.com
      eventTime: "2024-10-17 21:48:45.000000000"
      eventType: AwsApiCall
      eventVersion: "1.09"
      managementEvent: true
      readOnly: true
      recipientAccountId: "123123123123"
      requestParameters:
        secretId: "arn:aws:secretsmanager:us-west-2:123123123123:secret:secret1"
      sourceIPAddress: "123.123.123.123"
      tlsDetails:
        cipherSuite: "TLS_AES_128_GCM_SHA256"
        clientProvidedHostHeader: "secretsmanager.us-west-2.amazonaws.com"
        tlsVersion: "TLSv1.3"
      userAgent: "aws-cli/2.0"
      userIdentity:
        accessKeyId: "ASIASXP6SDP2LKLKYYC4"
        accountId: "123123123123"
        arn: "arn:aws:sts::123123123123:assumed-role/AWSReservedSSO_DevAdmin_635426549a280cc6/evil.genius"
        principalId: "AROASXP6SDP2F4WLQVARB:evil.genius"
        sessionContext:
          attributes:
            creationDate: "2024-10-17T21:48:13Z"
            mfaAuthenticated: "false"
          sessionIssuer:
            accountId: "123123123123"
            arn: "arn:aws:iam::123123123123:role/aws-reserved/sso.amazonaws.com/us-west-2/AWSReservedSSO_DevAdmin_635426549a280cc6"
            principalId: "AROASXP6SDP2F4WLQVARB"
            type: "Role"
            userName: "AWSReservedSSO_DevAdmin_635426549a280cc6"
        type: "AssumedRole"