AnalysisType: rule
Filename: cross_region_activity_demo.py
RuleID: "AWS.CrossRegion.Activity"
DisplayName: "Simultaneous Activity Across Multiple AWS Regions"
Enabled: true
LogTypes:
  - AWS.CloudTrail
Severity: High
DedupPeriodMinutes: 60
Threshold: 3
Description: |
  Detects when a single user or entity performs actions in 3 or more unique AWS regions within a 10 minute window. This may indicate credential compromise or automated attack activity.
Runbook: |
  1. Review CloudTrail activity for the user across all regions in the last 10 minutes.
  2. Confirm if the activity was expected or authorized (e.g., automation, multi-region deployment).
  3. Investigate for signs of credential compromise or automated attack.
  4. If suspicious, rotate credentials and review user permissions.
Reference: https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-event-reference.html
SummaryAttributes:
  - userIdentity.arn
  - awsRegion
  - eventName
  - sourceIPAddress
  - eventTime
Tags:
  - aws
  - credential-compromise
  - automation
  - compliance.soc2
Tests:
  - Name: Activity in three regions (should alert)
    ExpectedResult: true
    Mocks:
      - objectName: add_to_string_set
        returnValue: '["us-east-1", "us-west-2", "eu-central-1"]'
    Log:
      p_log_type: AWS.CloudTrail
      awsRegion: us-west-2
      eventName: RunInstances
      eventTime: "2024-07-01T12:00:00Z"
      userIdentity:
        arn: arn:aws:iam::123456789012:user/test-user
      sourceIPAddress: 1.2.3.4
      userAgent: aws-cli/2.0
  - Name: Activity in two regions (should not alert)
    ExpectedResult: false
    Mocks:
      - objectName: add_to_string_set
        returnValue: '["us-east-1", "us-west-2"]'
    Log:
      p_log_type: AWS.CloudTrail
      awsRegion: us-west-2
      eventName: RunInstances
      eventTime: "2024-07-01T12:00:00Z"
      userIdentity:
        arn: arn:aws:iam::123456789012:user/test-user
      sourceIPAddress: 1.2.3.4
      userAgent: aws-cli/2.0
  - Name: No user (should not alert)
    ExpectedResult: false
    Log:
      p_log_type: AWS.CloudTrail
      awsRegion: us-west-2
      eventName: RunInstances
      eventTime: "2024-07-01T12:00:00Z"
      userIdentity: {}
      sourceIPAddress: 1.2.3.4
      userAgent: aws-cli/2.0 